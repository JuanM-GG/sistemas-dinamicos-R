---
title: "Bioreactor"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

This notebook contein the module Biochemical reactors of the book "Dynamic Process: Modeling, Analysis and Simulation" 

```{r}
# load libraries
library(ggplot2)
library(deSolve)
library(GA)
library(tidyverse)
```

```{r}
# load Grind.R
source("Grind.R")
```

```{r}
# parameters
mu_max = 0.53
ks = 0.12
Y = 0.4
sf = 4.0
ki = 0.4545
```


```{r}
rates <- function(s) {
        
        mu_monod = mu_max*s/(ks + s)
        
        mu_inhib = mu_max*s/(ks + s + ki*s^2)
        
        return(list(mu_monod=mu_monod, mu_inhib=mu_inhib))
}
```

```{r}
s <- seq(0,10,len=100)
rates = rates(s)
```

```{r}
data <- data.frame(s = s, mu_monod = rates$mu_monod, mu_inhib = rates$mu_inhib)
```

```{r}
ggplot(data,aes(s)) +
  geom_line(aes(y=mu_monod, color = "monod"), lwd = 1) +
  geom_line(aes(y=mu_inhib, color = "inhibition"), lwd = 1) +
  scale_color_manual("", breaks = c("monod", "inhibition"),
                          values = c("red","blue")) +
  xlab("Substrate (g/L)") +
  ylab("Growth Rate (1/h)") +
  theme_bw()
```

Steady sate monod model

$$ss_1: S_s = S_f, \hspace{1cm} X_s = 0$$
$$ss_2: S_s = \frac{Dk_s}{\mu_{max} - D}, \hspace{1cm} X_s = Y(S_f - S) $$
steady state Monod model function
```{r} 
steady_state_monod <- function(p) {
        with(as.list(p), {
                
                # washout steady state 
                s1 = sf
                x1 = 0
                ss1 = c(s1 = s1, x1 = x1)
                
                # nontrivial steady state
                s2 = D*ks/(mu_max - D)
                x2 = Y*(sf - s2)
                ss2 = c(s2 = s2, x2 = x2)
                
                return(list(ss1 = ss1, ss2 = ss2))
        })
        
}
```

Steady state inhibition model 

$$ss_1: S_s = S_f, \hspace{1cm}, X_s = 0$$

$$ss_2: S_s = \frac{-(1 - \frac{mu_{max}}{D}) - \sqrt{(1 - \frac{mu_{max}}{D})^2 - 4k_ik_s}}{2k_i}, \hspace{1cm} X_s = Y(S_f - S) $$

$$ss_3: S_s = \frac{-(1 - \frac{mu_{max}}{D}) + \sqrt{(1 - \frac{mu_{max}}{D})^2 - 4k_ik_s}}{2k_i}, \hspace{1cm} X_s = Y(S_f - S) $$
steady state inhibition model function 
```{r}
steady_state_inhib <- function(p) {
        with(as.list(p), {
                
                # washout steady state 
                s1 = sf 
                x1 = 0
                ss1 = c(s1 = s1, x1 = x1)
                
                # steady state nontrivial 1
                s2 = (-(1-mu_max/D) + sqrt((1-mu_max/D)^2 - 4*ks*ki))/(2*ki)
                x2 = Y*(sf - s2)
                ss2 = c(s2 = s2, x2 = x2)
                
                # steady state nontrivial 2
                s3 = (-(1-mu_max/D) - sqrt((1-mu_max/D)^2 - 4*ks*ki))/(2*ki)
                x3 = Y*(sf - s3)
                ss3 = c(s3 = s3, x3 = x3)
                
                return(list(ss1 = ss1, ss2 = ss2, ss3 = ss3))
        })
}
```


```{r}
# case 1 D = 0.3
p <- c(mu_max = mu_max, ks = ks, Y = Y, sf = sf, ki = ki, D = 0.3)
```

```{r}
ss_monod <- steady_state_monod(p)
cat("Steady state Monod model\n")
ss_monod
```
```{r}
ss_inhib <- steady_state_inhib(p)
cat("Steady state inhibition model\n")
ss_inhib
```
### Dynamical simulation 

```{r}
# write mathematical models 
model <- function(t,state,parms) {
        with(as.list(c(state,parms)), {
                
                # state variables 
                # x1 biomass Monod 
                # s1 substrate monod 
                
                # x2 biomass inhibition 
                # s2 substrate inhibition 
                
                # parameters 
                # mu_max, ks, Y, ki
                
                # inputs
                # D
                
                # specific growth rate Monod
                mu_mod = mu_max*s1/(ks + s1)
                
                # specific growth rate Inhibition
                mu_inhib = mu_max*s2/(ks + s2 + ki*s2^2)
                
                # Monod
                # component balance on biomass 
                dx1dt = (mu_mod-D)*x1 
                # component balance substrate
                ds1dt = D*(sf - s1) - (1/Y)*mu_mod*x1
                
                # Inhibition
                # component balance on biomass 
                dx2dt = (mu_inhib-D)*x2
                # component balance substrate
                ds2dt = D*(sf - s2) - (1/Y)*mu_inhib*x2
                
                return(list(c(dx1dt,ds1dt,dx2dt,ds2dt)))
        })
}
```


```{r}
# integration time
time <- seq(0,30,len=100)
```


```{r}
# intial conditions 
s <- list(s1 = c(x1 = 1, s1 = 1, x2 = 1, s2 = 1 ), 
          s2 = c(x1 = 0.75, s1 = 2, x2 = 0.75, s2 = 2))
```

```{r}
# simulate both models with initial condition (x = 1, s = 1)
out <- ode(y = s$s1, times = time, func = model, parms = p, method = "rk4")
```

```{r}
plot(out)
```

```{r}
# simulate both models with initial condition (x = 0.75, s = 2)
out <- ode(y = s$s2, times = time, func = model, parms = p, method = "rk4")
```

```{r}
plot(out)
```

### Stability analysis 

Monod model
```{r}
monod <- function(time,state,parms) {
        with(as.list(c(state,parms)), {
                
                mu = mu_max*s/(ks + s)
                
                dxdt = (mu-D)*x
                dsdt = D*(sf - s) - (1/Y)*mu*x
                
                return(list(c(dxdt,dsdt)))
        })
}
```

Inhibition model
```{r}
inhibition <- function(time,state,parms) {
        with(as.list(c(state,parms)), {
                
                mu = mu_max*s/(ks + s + ki*s^2)
                
                dxdt = (mu-D)*x
                dsdt = D*(sf - s) - (1/Y)*mu*x
                
                return(list(c(dxdt,dsdt)))
        })
}
```

#### Inhibition model
```{r}
# intial conditions 1
s1 <- c( x = 4, s = 0)
```


```{r}
newton(state = s1, parms = p, odes = inhibition,jacobian = T,vector = T)
```
```{r}
# initial condition 2
s2 <-c(x = 0.9951, s = 1.5122)
```

```{r}
newton(state = s2, parms = p, odes = inhibition, jacobian = T, vector = T)
```
The positive eigenvalue (0.1698) indicates that equilibrium 2 is unstable

```{r}
# steady state 3 
s3 = c(x = 1.5302, s = 0.1746)
```

```{r}
newton(state = s3, parms = p, odes = inhibition, jacobian = T, vector = T)
```
Both eigenvalues are negative, indicating that equilibrium point 3 is stable

### Phase plane analysis

```{r}
plane(xmin = -0.01,xmax = 2,ymin = -0.01,ymax = 5,state = s,parms = p,odes = inhibition, portrait = T)
newton(state = s1, odes = inhibition, plot = T)
newton(state = s2, odes = inhibition, plot = T)
newton(state = s3, odes = inhibition, plot = T)

```
#### Monod model 

```{r}
# initial condition 1
s1 <- c(x = 0, s = 4)
```

```{r}
newton(state = s1, parms = p, odes = monod, jacobian = T, vector = T)
```

```{r}
# initial condition 2  
s2 <- c(x = 1.5373913, s = 0.1565217)
```

```{r}
newton(state = s2, parms = p, odes = monod, jacobian = T,vector = T)
```

```{r}
plane(xmin = -0.01,xmax = 3,ymin = -0.01,ymax = 5, odes = monod, portrait = T)
newton(state = s1, odes = monod, plot = T)
newton(state = s2, odes = monod, plot = T)
```

